<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beat Master - Rhythm Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #gameCanvas {
            background: #000;
            box-shadow: 0 0 50px rgba(138, 43, 226, 0.5);
            border-radius: 10px;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 800px;
            height: 600px;
            pointer-events: none;
        }

        #hud {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            color: white;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.8);
        }

        .hud-item {
            background: rgba(138, 43, 226, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid rgba(138, 43, 226, 0.6);
        }

        #combo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            color: #FFD700;
            text-shadow: 0 0 20px #FFD700;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #judgment {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .perfect { color: #FFD700; text-shadow: 0 0 20px #FFD700; }
        .great { color: #4ECDC4; text-shadow: 0 0 20px #4ECDC4; }
        .good { color: #95E1D3; text-shadow: 0 0 20px #95E1D3; }
        .miss { color: #FF6B6B; text-shadow: 0 0 20px #FF6B6B; }

        #startScreen, #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: all;
        }

        #gameOver {
            display: none;
        }

        h1 {
            font-size: 64px;
            background: linear-gradient(45deg, #8A2BE2, #FF1493, #00CED1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.5)); }
            50% { filter: drop-shadow(0 0 30px rgba(138, 43, 226, 1)); }
        }

        button {
            padding: 20px 50px;
            font-size: 28px;
            background: linear-gradient(45deg, #8A2BE2, #FF1493);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.4);
            pointer-events: all;
        }

        button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(138, 43, 226, 0.6);
        }

        .instructions {
            margin-top: 30px;
            color: white;
            font-size: 18px;
            text-align: center;
        }

        .key {
            background: rgba(138, 43, 226, 0.5);
            padding: 8px 20px;
            border-radius: 8px;
            margin: 0 5px;
            font-weight: bold;
            border: 2px solid rgba(138, 43, 226, 0.8);
        }

        #finalStats {
            color: white;
            font-size: 24px;
            margin: 20px 0;
            text-align: center;
        }

        .stat-line {
            margin: 10px 0;
        }

        #difficultySelect {
            margin: 20px 0;
        }

        .difficulty-btn {
            padding: 15px 30px;
            margin: 0 10px;
            font-size: 20px;
            background: rgba(138, 43, 226, 0.3);
            color: white;
            border: 2px solid rgba(138, 43, 226, 0.6);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .difficulty-btn:hover {
            background: rgba(138, 43, 226, 0.5);
            transform: scale(1.05);
        }

        .difficulty-btn.selected {
            background: linear-gradient(45deg, #8A2BE2, #FF1493);
            border-color: #FFD700;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="ui">
        <div id="hud">
            <div class="hud-item">SCORE: <span id="score">0</span></div>
            <div class="hud-item">COMBO: <span id="comboDisplay">0</span></div>
            <div class="hud-item">ACCURACY: <span id="accuracy">100%</span></div>
        </div>

        <div id="combo"></div>
        <div id="judgment"></div>

        <div id="startScreen">
            <h1>ðŸŽµ BEAT MASTER</h1>
            <div id="difficultySelect">
                <button class="difficulty-btn selected" onclick="selectDifficulty('easy')">EASY</button>
                <button class="difficulty-btn" onclick="selectDifficulty('medium')">MEDIUM</button>
                <button class="difficulty-btn" onclick="selectDifficulty('hard')">HARD</button>
            </div>
            <button onclick="startGame()" style="margin-top: 20px;">START GAME</button>
            <div class="instructions">
                <div style="margin: 20px 0;">
                    Press <span class="key">D</span> <span class="key">F</span> <span class="key">J</span> <span class="key">K</span> when notes reach the target line!
                </div>
                <div>Match the rhythm and build your combo!</div>
            </div>
        </div>

        <div id="gameOver">
            <h1>SONG COMPLETE!</h1>
            <div id="finalStats"></div>
            <button onclick="restartGame()">PLAY AGAIN</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const LANES = 4;
        const LANE_WIDTH = 150;
        const START_X = (canvas.width - LANE_WIDTH * LANES) / 2;
        const TARGET_Y = 500;
        const NOTE_SPEED = 200;

        const TIMING_WINDOWS = {
            perfect: 50,
            great: 100,
            good: 150
        };

        const game = {
            running: false,
            difficulty: 'easy',
            score: 0,
            combo: 0,
            maxCombo: 0,
            notes: [],
            time: 0,
            perfect: 0,
            great: 0,
            good: 0,
            miss: 0,
            totalNotes: 0,
            keys: { d: false, f: false, j: false, k: false },
            keyLanes: { d: 0, f: 1, j: 2, k: 3 },
            laneGlow: [0, 0, 0, 0],
            patterns: {
                easy: [
                    [0, 0], [1, 0.5], [2, 1], [3, 1.5],
                    [0, 2.5], [2, 3], [1, 3.5], [3, 4],
                    [0, 5], [1, 5.5], [2, 6], [3, 6.5],
                    [0, 7.5], [1, 7.5], [2, 8], [3, 8.5],
                    [0, 9.5], [2, 10], [1, 10.5], [3, 11],
                    [0, 12], [1, 12], [2, 12.5], [3, 13],
                    [0, 14], [1, 14.5], [2, 15], [3, 15.5],
                    [0, 16.5], [2, 17], [1, 17.5], [3, 18]
                ],
                medium: [
                    [0, 0], [1, 0.25], [2, 0.5], [3, 0.75],
                    [0, 1.5], [2, 1.75], [1, 2], [3, 2.25],
                    [0, 3], [1, 3], [2, 3.5], [3, 3.75],
                    [0, 4.5], [2, 4.75], [1, 5], [3, 5.25],
                    [0, 6], [1, 6.25], [2, 6.5], [3, 6.75],
                    [0, 7.5], [1, 7.5], [2, 7.75], [3, 8],
                    [0, 9], [2, 9.25], [1, 9.5], [3, 9.75],
                    [0, 10.5], [1, 10.5], [2, 10.75], [3, 11],
                    [0, 12], [1, 12.25], [2, 12.5], [3, 12.75]
                ],
                hard: [
                    [0, 0], [1, 0.15], [2, 0.3], [3, 0.45],
                    [0, 1], [2, 1.15], [1, 1.3], [3, 1.45],
                    [0, 2], [1, 2], [2, 2.15], [3, 2.3],
                    [0, 3], [2, 3.15], [1, 3.3], [3, 3.45],
                    [0, 4], [1, 4.15], [2, 4.3], [3, 4.45],
                    [0, 5], [1, 5], [2, 5], [3, 5.15],
                    [0, 6], [2, 6.15], [1, 6.3], [3, 6.45],
                    [0, 7], [1, 7.15], [2, 7.3], [3, 7.45],
                    [0, 8], [1, 8], [2, 8], [3, 8],
                    [0, 9], [2, 9.15], [1, 9.3], [3, 9.45]
                ]
            }
        };

        const laneColors = ['#FF6B6B', '#4ECDC4', '#FFD93D', '#6BCF7F'];
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function selectDifficulty(diff) {
            game.difficulty = diff;
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            game.running = true;
            game.score = 0;
            game.combo = 0;
            game.maxCombo = 0;
            game.notes = [];
            game.time = 0;
            game.perfect = 0;
            game.great = 0;
            game.good = 0;
            game.miss = 0;

            // Load pattern
            const pattern = game.patterns[game.difficulty];
            game.totalNotes = pattern.length;

            pattern.forEach(([lane, time]) => {
                game.notes.push({
                    lane: lane,
                    y: -100,
                    spawnTime: time,
                    spawned: false,
                    hit: false
                });
            });

            gameLoop();
        }

        function restartGame() {
            document.getElementById('gameOver').style.display = 'none';
            startGame();
        }

        // Controls
        document.addEventListener('keydown', e => {
            const key = e.key.toLowerCase();
            if (game.keyLanes.hasOwnProperty(key) && !game.keys[key]) {
                game.keys[key] = true;
                const lane = game.keyLanes[key];
                game.laneGlow[lane] = 1;
                checkHit(lane);
                playHitSound();
            }
        });

        document.addEventListener('keyup', e => {
            const key = e.key.toLowerCase();
            if (game.keyLanes.hasOwnProperty(key)) {
                game.keys[key] = false;
            }
        });

        function checkHit(lane) {
            if (!game.running) return;

            let closestNote = null;
            let closestDist = Infinity;

            game.notes.forEach(note => {
                if (note.lane === lane && !note.hit && note.spawned) {
                    const dist = Math.abs(note.y - TARGET_Y);
                    if (dist < closestDist && dist < TIMING_WINDOWS.good) {
                        closestDist = dist;
                        closestNote = note;
                    }
                }
            });

            if (closestNote) {
                closestNote.hit = true;
                const dist = closestDist;

                let judgment = '';
                let points = 0;

                if (dist < TIMING_WINDOWS.perfect) {
                    judgment = 'PERFECT!';
                    points = 100;
                    game.perfect++;
                    game.combo++;
                } else if (dist < TIMING_WINDOWS.great) {
                    judgment = 'GREAT!';
                    points = 75;
                    game.great++;
                    game.combo++;
                } else if (dist < TIMING_WINDOWS.good) {
                    judgment = 'GOOD';
                    points = 50;
                    game.good++;
                    game.combo++;
                }

                game.score += points * (1 + game.combo * 0.1);
                game.maxCombo = Math.max(game.maxCombo, game.combo);

                showJudgment(judgment);
                updateComboDisplay();
            }
        }

        function showJudgment(text) {
            const el = document.getElementById('judgment');
            el.textContent = text;
            el.className = text.toLowerCase().replace('!', '');
            el.style.opacity = 1;
            setTimeout(() => { el.style.opacity = 0; }, 300);
        }

        function updateComboDisplay() {
            document.getElementById('comboDisplay').textContent = game.combo;
            if (game.combo > 3) {
                const el = document.getElementById('combo');
                el.textContent = `${game.combo}x COMBO!`;
                el.style.opacity = 0.8;
                setTimeout(() => { el.style.opacity = 0; }, 500);
            }
        }

        function playHitSound() {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.connect(gain);
            gain.connect(audioContext.destination);

            osc.frequency.value = 440 + game.combo * 20;
            osc.type = 'sine';

            gain.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + 0.1);
        }

        function update(dt) {
            if (!game.running) return;

            game.time += dt;

            // Spawn notes
            game.notes.forEach(note => {
                if (!note.spawned && game.time >= note.spawnTime) {
                    note.spawned = true;
                }

                if (note.spawned && !note.hit) {
                    note.y += NOTE_SPEED * dt;

                    // Miss note if it passed
                    if (note.y > TARGET_Y + TIMING_WINDOWS.good) {
                        note.hit = true;
                        game.miss++;
                        game.combo = 0;
                        showJudgment('MISS');
                    }
                }
            });

            // Update lane glow
            game.laneGlow = game.laneGlow.map(g => Math.max(0, g - dt * 3));

            // Check if song complete
            const allNotesHit = game.notes.every(note => note.hit);
            if (allNotesHit && game.notes.length > 0) {
                gameOver();
            }

            updateHUD();
        }

        function gameOver() {
            game.running = false;
            const accuracy = ((game.perfect + game.great + game.good) / game.totalNotes * 100).toFixed(1);

            document.getElementById('gameOver').style.display = 'flex';
            document.getElementById('finalStats').innerHTML = `
                <div class="stat-line">FINAL SCORE: ${Math.floor(game.score)}</div>
                <div class="stat-line">MAX COMBO: ${game.maxCombo}</div>
                <div class="stat-line">ACCURACY: ${accuracy}%</div>
                <div class="stat-line" style="margin-top: 20px; font-size: 18px;">
                    <span class="perfect">PERFECT: ${game.perfect}</span> |
                    <span class="great">GREAT: ${game.great}</span> |
                    <span class="good">GOOD: ${game.good}</span> |
                    <span class="miss">MISS: ${game.miss}</span>
                </div>
            `;
        }

        function updateHUD() {
            document.getElementById('score').textContent = Math.floor(game.score);
            const totalHit = game.perfect + game.great + game.good + game.miss;
            const accuracy = totalHit > 0 ? ((game.perfect + game.great + game.good) / totalHit * 100).toFixed(1) : 100;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        function render() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw lanes
            for (let i = 0; i < LANES; i++) {
                const x = START_X + i * LANE_WIDTH;

                // Lane background
                ctx.fillStyle = `rgba(${parseInt(laneColors[i].slice(1,3), 16)}, ${parseInt(laneColors[i].slice(3,5), 16)}, ${parseInt(laneColors[i].slice(5,7), 16)}, ${0.1 + game.laneGlow[i] * 0.3})`;
                ctx.fillRect(x, 0, LANE_WIDTH, canvas.height);

                // Lane divider
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }

            // Draw target line
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 4;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(START_X, TARGET_Y);
            ctx.lineTo(START_X + LANE_WIDTH * LANES, TARGET_Y);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw target indicators
            for (let i = 0; i < LANES; i++) {
                const x = START_X + i * LANE_WIDTH + LANE_WIDTH / 2;

                ctx.strokeStyle = laneColors[i];
                ctx.fillStyle = `rgba(${parseInt(laneColors[i].slice(1,3), 16)}, ${parseInt(laneColors[i].slice(3,5), 16)}, ${parseInt(laneColors[i].slice(5,7), 16)}, ${0.3 + game.laneGlow[i] * 0.4})`;
                ctx.lineWidth = 4;

                ctx.beginPath();
                ctx.rect(x - 40, TARGET_Y - 20, 80, 40);
                ctx.fill();
                ctx.stroke();

                // Key label
                const keys = ['D', 'F', 'J', 'K'];
                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(keys[i], x, TARGET_Y);
            }

            // Draw notes
            game.notes.forEach(note => {
                if (note.spawned && !note.hit) {
                    const x = START_X + note.lane * LANE_WIDTH + LANE_WIDTH / 2;

                    // Note glow
                    const gradient = ctx.createRadialGradient(x, note.y, 0, x, note.y, 30);
                    gradient.addColorStop(0, laneColors[note.lane]);
                    gradient.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x - 40, note.y - 40, 80, 80);

                    // Note
                    ctx.fillStyle = laneColors[note.lane];
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(x, note.y, 20, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();

                    // Note center
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(x, note.y, 8, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }

        // Game loop
        let lastTime = performance.now();

        function gameLoop() {
            const currentTime = performance.now();
            const dt = Math.min((currentTime - lastTime) / 1000, 0.1);
            lastTime = currentTime;

            update(dt);
            render();

            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>